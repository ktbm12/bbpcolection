{% extends "base.html" %}
{% load static i18n humanize %}

{% block title %}{{ product.name }} - bbpcollection{% endblock %}

{% block extra_head %}
<style>
    .gallery-thumb.active {
        border-color: #d4af37;
        box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
    }
    .recommendation-card:hover img {
        transform: scale(1.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="pt-32 pb-20 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Breadcrumb -->
        <nav class="flex mb-8 text-sm text-gray-500 font-medium">
            <a href="{% url 'users:home' %}" class="hover:text-yellow-600 transition">Accueil</a>
            <span class="mx-3 text-gray-300">/</span>
            <a href="{% url 'product:product_list' %}" class="hover:text-yellow-600 transition">Collections</a>
            <span class="mx-3 text-gray-300">/</span>
            <span class="text-black font-bold">{{ product.name }}</span>
        </nav>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 bg-white rounded-[2.5rem] shadow-2xl shadow-black/5 overflow-hidden p-6 sm:p-10 lg:p-16">
            
            <!-- Product Images (Column 1-7) -->
            <div class="lg:col-span-7 space-y-6">
                <div class="aspect-[4/5] sm:aspect-square bg-gray-50 rounded-[2rem] overflow-hidden shadow-inner group relative">
                    {% if product.get_main_image_url %}
                        <img id="main-product-image" src="{{ product.get_main_image_url }}" alt="{{ product.name }}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105">
                    {% else %}
                        <div class="w-full h-full flex items-center justify-center text-gray-300">
                            <i class="fas fa-image text-8xl opacity-20"></i>
                        </div>
                    {% endif %}
                    
                    <!-- Zoom Overlay Button (Simulated) -->
                    <div class="absolute bottom-6 right-6">
                        <button class="w-12 h-12 bg-white/90 backdrop-blur-md rounded-full shadow-lg flex items-center justify-center text-gray-900 hover:bg-yellow-600 hover:text-white transition-all transform hover:scale-110">
                            <i class="fas fa-expand-alt"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Gallery Thumbnails -->
                <div class="grid grid-cols-5 gap-4">
                    {% if product.get_main_image_url %}
                    <div class="gallery-thumb active aspect-square bg-gray-50 rounded-2xl overflow-hidden cursor-pointer border-2 border-transparent transition-all group" 
                         onclick="changeMainImage('{{ product.get_main_image_url }}', this)">
                        <img src="{{ product.get_main_image_url }}" alt="{{ product.name }}" class="w-full h-full object-cover group-hover:scale-110 transition-transform">
                    </div>
                    {% endif %}
                    
                    {% for img in product.gallery.all %}
                        <div class="gallery-thumb aspect-square bg-gray-50 rounded-2xl overflow-hidden cursor-pointer border-2 border-transparent transition-all group"
                             onclick="changeMainImage('{{ img.image.url }}', this)">
                            <img src="{{ img.image.url }}" alt="{{ product.name }}" class="w-full h-full object-cover group-hover:scale-110 transition-transform">
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Product Info (Column 8-12) -->
            <div class="lg:col-span-5 flex flex-col pt-4">
                <div class="mb-10">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="px-3 py-1 bg-yellow-600/10 text-yellow-700 text-[10px] font-black uppercase tracking-[0.2em] rounded-full">
                            {{ product.category.name }}
                        </span>
                        {% if product.is_featured %}
                        <span class="px-3 py-1 bg-black text-white text-[10px] font-black uppercase tracking-[0.2em] rounded-full">
                            Vedette
                        </span>
                        {% endif %}
                    </div>
                    
                    <h1 class="text-4xl sm:text-5xl font-serif font-bold text-gray-900 mb-6 leading-tight">{{ product.name }}</h1>
                    
                    <div class="flex items-baseline gap-6 mb-8">
                        <span class="text-4xl font-black text-black">{{ product.price|floatformat:0|intcomma }} FCFA</span>
                        {% if product.old_price %}
                            <span class="text-xl text-gray-400 line-through font-medium">{{ product.old_price|floatformat:0|intcomma }} FCFA</span>
                            <div class="bg-red-500 text-white px-3 py-1 rounded-lg text-xs font-black">
                                -{{ product.discount_percentage }}%
                            </div>
                        {% endif %}
                    </div>

                    <div class="flex items-center gap-3 mb-10 pb-8 border-b border-gray-100 italic text-gray-500">
                        <div class="flex text-yellow-500 items-center">
                            <i class="fas fa-star text-sm"></i>
                            <i class="fas fa-star text-sm"></i>
                            <i class="fas fa-star text-sm"></i>
                            <i class="fas fa-star text-sm"></i>
                            <i class="fas fa-star-half-alt text-sm"></i>
                        </div>
                        <span class="text-sm">(4.8/5 • 128 avis clients)</span>
                    </div>
                </div>

                <!-- Description -->
                <div class="prose prose-sm text-gray-600 mb-10 leading-relaxed max-w-none">
                    <p class="font-medium text-gray-900 mb-2 uppercase tracking-widest text-[10px]">Description</p>
                    <p>{{ product.description|linebreaks }}</p>
                </div>

                <div class="space-y-8 mt-auto">
                    <!-- Stock status -->
                    <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-2xl border border-gray-100">
                        {% if product.stock > 0 %}
                            <div class="relative flex items-center justify-center">
                                <span class="absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75 animate-ping"></span>
                                <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                            </div>
                            <div>
                                <p class="text-sm font-bold text-gray-900">En Stock</p>
                                <p class="text-[10px] text-gray-500 uppercase font-black tracking-widest">{{ product.stock }} unités disponibles</p>
                            </div>
                        {% else %}
                            <span class="inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                            <p class="text-sm font-bold text-red-600">Rupture de stock</p>
                        {% endif %}
                    </div>

                    <!-- Add to Cart (Desktop View) -->
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button onclick="addToCart('{{ product.id }}')" 
                                class="flex-1 py-5 bg-black text-white font-black uppercase tracking-[0.2em] text-xs rounded-2xl hover:bg-yellow-600 hover:text-black transition-all shadow-2xl shadow-yellow-600/10 active:scale-95 flex items-center justify-center gap-4">
                            <i class="fas fa-shopping-bag text-base"></i>
                            Ajouter au Panier
                        </button>
                        <button class="p-5 border-2 border-gray-100 rounded-2xl text-gray-900 hover:text-red-500 hover:bg-gray-50 transition-all active:scale-95">
                            <i class="far fa-heart text-xl"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Features Grid -->
                <div class="grid grid-cols-2 gap-y-6 gap-x-8 mt-12 pt-10 border-t border-gray-100 text-[10px] font-black uppercase tracking-widest text-gray-400">
                    <div class="flex items-center gap-4 group">
                        <div class="w-10 h-10 bg-gray-50 rounded-xl flex items-center justify-center group-hover:bg-yellow-600/10 group-hover:text-yellow-600 transition">
                            <i class="fas fa-truck text-base"></i>
                        </div>
                        <span>Livraison Offerte</span>
                    </div>
                    <div class="flex items-center gap-4 group">
                        <div class="w-10 h-10 bg-gray-50 rounded-xl flex items-center justify-center group-hover:bg-yellow-600/10 group-hover:text-yellow-600 transition">
                            <i class="fas fa-undo text-base"></i>
                        </div>
                        <span>Retours 30j</span>
                    </div>
                    <div class="flex items-center gap-4 group">
                        <div class="w-10 h-10 bg-gray-50 rounded-xl flex items-center justify-center group-hover:bg-yellow-600/10 group-hover:text-yellow-600 transition">
                            <i class="fas fa-shield-alt text-base"></i>
                        </div>
                        <span>Paiement Sécurisé</span>
                    </div>
                    <div class="flex items-center gap-4 group">
                        <div class="w-10 h-10 bg-gray-50 rounded-xl flex items-center justify-center group-hover:bg-yellow-600/10 group-hover:text-yellow-600 transition">
                            <i class="fas fa-gem text-base"></i>
                        </div>
                        <span>Authenticité</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recommendations Section -->
        {% if related_products %}
        <div class="mt-24">
            <div class="flex items-end justify-between mb-12">
                <div>
                    <p class="text-yellow-600 font-black uppercase tracking-[0.3em] text-xs mb-3">Recommandations</p>
                    <h2 class="text-4xl font-serif font-bold text-gray-900">Complétez votre Style</h2>
                </div>
                <a href="{% url 'product:product_list' %}" class="hidden sm:inline-flex items-center gap-2 text-black font-black uppercase tracking-widest text-xs hover:text-yellow-600 transition">
                    Tout voir <i class="fas fa-arrow-right text-[10px]"></i>
                </a>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                {% for item in related_products %}
                <a href="{% url 'product:product_detail' item.id %}" class="recommendation-card group">
                    <div class="aspect-[3/4] rounded-[2rem] overflow-hidden bg-gray-100 mb-6 relative">
                        {% if item.main_image %}
                            <img src="{{ item.main_image.url }}" alt="{{ item.name }}" class="w-full h-full object-cover transition-transform duration-700">
                        {% endif %}
                        <div class="absolute inset-0 bg-black/5 group-hover:bg-black/0 transition-colors"></div>
                    </div>
                    <p class="text-gray-400 font-black uppercase tracking-widest text-[9px] mb-2">{{ item.category.name }}</p>
                    <h3 class="text-lg font-bold text-gray-900 group-hover:text-yellow-600 transition mb-1">{{ item.name }}</h3>
                    <p class="font-bold text-gray-500 text-sm">{{ item.price|floatformat:0|intcomma }} FCFA</p>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    function changeMainImage(url, thumb) {
        const mainImg = document.getElementById('main-product-image');
        if (!mainImg) return;
        
        mainImg.classList.add('opacity-50');
        setTimeout(() => {
            mainImg.src = url;
            mainImg.classList.remove('opacity-50');
        }, 300);

        document.querySelectorAll('.gallery-thumb').forEach(t => t.classList.remove('active'));
        thumb.classList.add('active');
    }

    function addToCart(productId) {
        const formData = new FormData();
        formData.append('quantity', 1);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch(`/product/add/${productId}/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Utiliser le nouveau système de notification (implémenté dans base.html ensuite)
                if (window.showPremiumNotification) {
                    window.showPremiumNotification('Produit ajouté au panier !', 'success');
                }
                // Update navbar count if possible
                document.querySelectorAll('.cart-items-badge').forEach(badge => {
                    badge.textContent = data.cart_items_count;
                });
            }
        })
        .catch(error => console.error('Erreur:', error));
    }
</script>
{% endblock %}
