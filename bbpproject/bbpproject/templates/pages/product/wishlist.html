{% extends 'base.html' %}
{% load static humanize product_tags %}

{% block title %}Ma Wishlist - bbpcollection{% endblock %}

{% block extra_css %}
<style>
    .product-card {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    
    .product-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.1), transparent);
        transition: left 0.6s;
        z-index: 1;
    }
    
    .product-card:hover::before {
        left: 100%;
    }
    
    .product-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
    }
    
    .product-image {
        position: relative;
        overflow: hidden;
    }
    
    .product-image::after {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(to top, rgba(0,0,0,0.4) 0%, transparent 40%);
        opacity: 0;
        transition: opacity 0.4s;
    }
    
    .product-card:hover .product-image::after {
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="pt-32 pb-20 bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-12 gap-6">
            <div>
                <h1 class="text-4xl font-serif font-bold text-gray-900 mb-2">Ma Wishlist</h1>
                <p class="text-gray-500">{{ wishlist_items.count }} article{{ wishlist_items.count|pluralize }} sauvegardé{{ wishlist_items.count|pluralize }}</p>
            </div>
            
            {% if wishlist_items %}
            <button onclick="addAllToCart()" class="bg-black hover:bg-yellow-600 text-white hover:text-black px-8 py-4 rounded-full font-bold uppercase tracking-widest text-xs transition-all shadow-xl hover:shadow-yellow-600/20 active:scale-95 flex items-center gap-3">
                <i class="fas fa-shopping-bag text-lg"></i>
                Tout ajouter au panier
            </button>
            {% endif %}
        </div>

        {% if wishlist_items %}
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                {% for product in wishlist_items %}
                <div class="product-card bg-white rounded-2xl overflow-hidden border-2 border-gray-200 hover:border-yellow-600 group flex flex-col">
            
                    <!-- IMAGE -->
                    <div class="product-image relative h-80 overflow-hidden flex-shrink-0">
                        <a href="{% url 'product:product_detail' product.id %}" class="absolute inset-0">
                            {% if product.get_main_image_url %}
                                <img src="{{ product.get_main_image_url }}" alt="{{ product.name }}"
                                     class="w-full h-full object-cover group-hover:scale-110 transition duration-700">
                            {% else %}
                                <div class="absolute inset-0 bg-gray-100 flex items-center justify-center">
                                    <i class="fas fa-image text-gray-300 text-7xl"></i>
                                </div>
                            {% endif %}
                        </a>
                        
                        <!-- Remove Button (Absolute Top Right) -->
                        <button onclick="removeFromWishlist('{{ product.id }}', this)" 
                                class="absolute top-4 right-4 z-10 w-10 h-10 bg-white/90 backdrop-blur rounded-full flex items-center justify-center text-red-500 hover:bg-red-500 hover:text-white transition shadow-md">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
            
                    <!-- CONTENT -->
                    <div class="p-5 flex flex-col flex-grow justify-between">
            
                        <!-- HEADER -->
                        <div class="product-card-header flex justify-between items-start mb-2">
                            <div>
                                <p class="text-sm text-gray-600">
                                    {{ product.category.name|default:"Catégorie" }}
                                </p>
                            </div>
                            
                            <!-- Rating -->
                            <div class="flex items-center gap-1">
                                <span class="text-sm font-semibold">{{ product.avg_rating|default:0|floatformat:1 }}</span>
                                <i class="fas fa-star text-yellow-500 text-xs"></i>
                            </div>
                        </div>
            
                        <!-- TITLE + PRICE -->
                        <div class="mb-4">
                            <a href="{% url 'product:product_detail' product.id %}">
                                <h3 class="font-semibold line-clamp-2 hover:text-yellow-600 mb-1 transition">
                                    {{ product.name }}
                                </h3>
                            </a>
                            
                            <div class="flex items-baseline gap-2">
                                <span class="font-bold text-black text-lg">{{ product.price|floatformat:0|intcomma }} FCFA</span>
                                {% if product.old_price %}
                                <span class="line-through text-gray-400 text-sm">
                                    {{ product.old_price|floatformat:0|intcomma }} FCFA
                                </span>
                                {% endif %}
                            </div>
                        </div>
            
                        <!-- ACTIONS -->
                        <div class="mt-auto">
                            <button onclick="addToCart('{{ product.id }}')"
                                    class="w-full bg-yellow-600 hover:bg-yellow-700 text-black py-3 rounded-lg text-sm font-bold uppercase tracking-wide transition-colors flex items-center justify-center gap-2">
                                <i class="fas fa-cart-plus"></i>
                                Ajouter au panier
                            </button>
                        </div>
            
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-20 animate-fade-in">
                <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6 text-gray-300">
                    <i class="far fa-heart text-4xl"></i>
                </div>
                <h3 class="text-2xl font-serif font-bold text-gray-900 mb-2">Votre wishlist est vide</h3>
                <p class="text-gray-500 mb-8 max-w-md mx-auto">Parcourez nos collections et sauvegardez vos coups de cœur pour plus tard.</p>
                <a href="{% url 'product:product_list' %}" class="inline-flex items-center px-8 py-4 bg-black text-white font-black uppercase tracking-widest text-xs rounded-full hover:bg-yellow-600 hover:text-black transition shadow-xl shadow-black/10">
                    Commencer le shopping
                </a>
            </div>
        {% endif %}

    </div>
</div>

<script>
    function removeFromWishlist(productId, btn) {
        if(!confirm('Retirer cet article de la wishlist ?')) return;

        fetch(`/product/wishlist/toggle/${productId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                // Remove card animation
                const card = btn.closest('.product-card');
                card.style.transform = 'scale(0.9)';
                card.style.opacity = '0';
                
                setTimeout(() => {
                    card.remove();
                    // If no items left, reload
                    if(document.querySelectorAll('.product-card').length === 0) {
                        window.location.reload();
                    }
                }, 300);
                
                // Update badge
                const badge = document.getElementById('wishlist-badge');
                if(badge) {
                    badge.textContent = data.wishlist_count;
                    if(data.wishlist_count === 0) badge.classList.add('hidden');
                }
                
                showNotification('Retiré de la wishlist');
            }
        });
    }

    function addToCart(productId) {
        fetch(`/product/add/${productId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ quantity: 1 })
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                if (window.showPremiumNotification) window.showPremiumNotification('Produit ajouté au panier !');
                document.querySelectorAll('.cart-items-badge').forEach(badge => {
                    badge.textContent = data.cart_items_count;
                });
            }
        });
    }

    function addAllToCart() {
        if(!confirm('Ajouter tous les articles au panier ?')) return;

        fetch('{% url "product:wishlist_add_all_to_cart" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                if (window.showPremiumNotification) window.showPremiumNotification(data.message);
                setTimeout(() => window.location.href = "{% url 'product:cart_detail' %}", 1000);
            }
        });
    }

    function showNotification(message) {
        if (window.showPremiumNotification) {
            window.showPremiumNotification(message, 'success');
        } else {
            alert(message);
        }
    }
</script>
{% endblock %}
